<?xml version="1.0"?>
<codeTemplate xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" id="BAB54F5E-E03F-4eaf-8253-B05BDC80EF44" name="Default-SData-SalesLogix" entityType="Entity" templateType="sdata" templateEngineType="T4">
  <template><![CDATA[<#@ template language="C#v3.5" #>
<#@ assembly name="System.Core.dll" #>
<#@ assembly name="Microsoft.Unity.dll" #>
<#@ assembly name="Sage.Common.Syndication.dll" #>
<#@ assembly name="Sage.Platform.dll" #>
<#@ assembly name="Sage.Platform.Orm.CodeGen.dll" #>
<#@ assembly name="Sage.Platform.Projects.dll" #>
<#@ import namespace="System" #>
<#@ import namespace="System.Collections" #>
<#@ import namespace="System.Linq" #>
<#@ import namespace="Microsoft.Practices.Unity" #>
<#@ import namespace="Sage.Common.Syndication" #>
<#@ import namespace="Sage.Platform.Orm.CodeGen" #>
<#@ import namespace="Sage.Platform.Orm.Entities" #>
<#
var entity = (OrmEntity) Context["entity"];
var generator = (SDataEntityCodeGenerator) Context["generator"];

var entityDisplayName = entity.DisplayName ?? entity.Name;
var entityDisplayNamePlural = entity.DisplayNamePlural ?? entity.PluralName;

var parents = entity.ParentEntities.Where(relation => relation.ChildProperty.Include && relation.ParentEntity.GenerateSDataFeed).ToList();
var children = entity.ChildEntities.Where(relation => relation.ParentProperty.Include && relation.ChildEntity.GenerateSDataFeed).ToList();
var extenders = entity.ExtensionEntities.Where(extender => extender.GenerateSDataFeed).ToList();
var methods = entity.Methods
    .Where(method => IsTypeSupported(method.RuntimeReturnType) &&
                     method.MethodParameters.All(param => IsTypeSupported(param.RuntimeParamType)) &&
                     (method.RuntimeReturnType.Namespace != "Sage.Entity.Interfaces" || OrmEntity.GetByName(entity.Project, method.RuntimeReturnType.Name.Substring(1)).GenerateSDataFeed))
    .Where(method =>
               {
                   var returnItemType = GetGenericCollectionItemType(method.RuntimeReturnType);
                   return returnItemType == null || returnItemType.Namespace != "Sage.Entity.Interfaces" || OrmEntity.GetByName(entity.Project, returnItemType.Name.Substring(1)).GenerateSDataFeed;
               })
    .ToList();
var properties = OrmEntity.GetIncludedProperties(entity).OfType<OrmFieldProperty>()
    .Where(prop => prop != entity.UniqueIdentifierProperty)
    .ToList();
var customProperties = OrmEntity.GetIncludedCustomProperties(entity)
    .Where(prop => IsTypeSupported(prop.RuntimeReturnType) &&
                   (prop.RuntimeReturnType.Namespace != "Sage.Entity.Interfaces" || OrmEntity.GetByName(entity.Project, prop.RuntimeReturnType.Name.Substring(1)).GenerateSDataFeed))
    .Where(prop =>
               {
                   var returnItemType = GetGenericCollectionItemType(prop.RuntimeReturnType);
                   return returnItemType == null || returnItemType.Namespace != "Sage.Entity.Interfaces" || OrmEntity.GetByName(entity.Project, returnItemType.Name.Substring(1)).GenerateSDataFeed;
               })
    .ToList();
#>
//------------------------------------------------------------------------------
// <autogenerated>
//     This code was generated by a tool.
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </autogenerated>
//------------------------------------------------------------------------------

// disable XML documentation warnings
#pragma warning disable 1591

using System;
using System.Collections;
using System.Collections.Generic;
using System.ComponentModel;
using System.Xml;
using System.Xml.Serialization;
using NHibernate;
using Sage.Common.Metadata;
using Sage.Common.Metadata.Model;
using Sage.Common.Syndication;
using Sage.Entity.Interfaces;
using Sage.Integration.Entity.Feeds;
using Sage.Integration.Messaging.Model;
using Sage.Integration.Presentation.Model;
using Sage.Platform;
using Sage.Platform.ComponentModel;
using Sage.Platform.Orm;
using Sage.Platform.SData;

#region Adapter Related Classes

namespace Sage.Integration.Entity.Adapter
{
    [RequestPath(<#= entity.Name #>Feed.ResourcePath)]
    public class <#= entity.Name #>RequestHandler : RequestHandlerBase<<#= entity.Name #>Feed, <#= entity.Name #>Entry, <#= entity.InterfaceName #>>
    {
        public <#= entity.Name #>RequestHandler()
            : base(<#= entity.Name #>Feed.ResourceName, <#= entity.Name #>Feed.ResourcePath) {}

        internal <#= entity.Name #>RequestHandler(IRequestHandler parentRequest, string forwardPath, string backwardPath, bool isSingle)
            : base(<#= entity.Name #>Feed.ResourceName, <#= entity.Name #>Feed.ResourcePath, parentRequest, forwardPath, backwardPath, isSingle) {}

<# if (parents.Count > 0) { #>
        #region M:1 Relationships
<#  foreach (var relation in parents) { #>
<#   var propName = relation.ChildProperty.PropertyName; #>
<#   var backwardPath = relation.ParentProperty.Include ? relation.ParentProperty.PropertyName : null; #>
<#   RequestRelatedHandler(propName, relation.ParentEntity.Name, propName, backwardPath, true); #>
<#  } #>
        #endregion
<# } #>

<# if (children.Count > 0) { #>
        #region 1:M Relationships
<#  foreach (var relation in children) { #>
<#   var propName = relation.ParentProperty.PropertyName; #>
<#   var backwardPath = relation.ChildProperty.Include ? relation.ChildProperty.PropertyName : null; #>
<#   RequestRelatedHandler(propName, relation.ChildEntity.Name, propName, backwardPath, relation.Cardinality != "1:M"); #>
<#  } #>
        #endregion
<# } #>

<# if (entity.IsExtension) { #>
<#  var parent = entity.ExtendedEntity; #>
<#  if (parent.GenerateSDataFeed) { #>
        #region 1:1 Parent Entity Extension
<#   var propName = parent.Name; #>
<#   RequestRelatedHandler(propName, propName, propName, entity.Name, true); #>
        #endregion
<#  } #>
<# } #>

<# if (extenders.Count > 0) { #>
        #region Child Extensions
<#  foreach (var child in extenders) { #>
<#   var propName = child.Name; #>
<#   RequestRelatedHandler(propName, propName, propName, entity.Name, true); #>
<#  } #>
        #endregion
<# } #>

        #region Abstract Overrides

        protected override IRequestHandler GetRelatedHandler(string path)
        {
            switch (path.ToLower())
            {
<# if (parents.Count > 0) { #>
                #region M:1 Relationships
<#  foreach (var relation in parents) { #>
                case "<#= relation.ChildProperty.PropertyName.ToLower() #>":
                    return <#= relation.ChildProperty.PropertyName #>RequestHandler;
<#  } #>
                #endregion
<# } #>

<# if (children.Count > 0) { #>
                #region 1:M Relationships
<#  foreach (var relation in children) { #>
                case "<#= relation.ParentProperty.PropertyName.ToLower() #>":
                    return <#= relation.ParentProperty.PropertyName #>RequestHandler;
<#  } #>
                #endregion
<# } #>

<# if (entity.IsExtension) { #>
<#  var parent = entity.ExtendedEntity; #>
<#  if (parent.GenerateSDataFeed) { #>
                #region 1:1 Parent Entity Extension
                case "<#= parent.Name.ToLower() #>":
                    return <#= parent.Name #>RequestHandler;
                #endregion
<#  } #>
<# } #>

<# if (extenders.Count > 0) { #>
                #region Child Extensions
<#  foreach (var child in extenders) { #>
                case "<#= child.Name.ToLower() #>":
                    return <#= child.Name #>RequestHandler;
<#  } #>
                #endregion
<# } #>
                default:
                    return base.GetRelatedHandler(path);
            }
        }

        protected override void BuildTemplateEntity(<#= entity.InterfaceName #> entity, InclusionNode include)
        {
<# if (parents.Count > 0) { #>
            #region M:1 Relationships
<#  foreach (var relation in parents) { #>
<#   var precedence = (int) relation.ChildProperty.DisplayCategory; #>
<#   RequestBuildTemplateEntity(relation.ChildProperty.PropertyName, false, precedence); #>
<#  } #>
            #endregion
<# } #>

<# if (children.Count > 0) { #>
            #region 1:M Relationships
<#  foreach (var relation in children) { #>
<#   var isCollection = (relation.Cardinality == "1:M"); #>
<#   var precedence = (int) relation.ParentProperty.DisplayCategory; #>
<#   RequestBuildTemplateEntity(relation.ParentProperty.PropertyName, isCollection, precedence); #>
<#  } #>
            #endregion
<# } #>

<# if (entity.IsExtension) { #>
<#  var parent = entity.ExtendedEntity; #>
<#  if (parent.GenerateSDataFeed) { #>
            #region 1:1 Parent Entity Extension
<#   RequestBuildTemplateEntity(parent.Name, false, 3); #>
            #endregion
<#  } #>
<# } #>

<# if (extenders.Count > 0) { #>
            #region Child Extensions
<#  foreach (var child in extenders) { #>
<#   RequestBuildTemplateEntity(child.Name, false, 3); #>
<#  } #>
            #endregion
<# } #>
        }

<# if (methods.Count > 0) { #>
        protected override void BuildServiceFeed(IFeed feed)
        {
<#  foreach (var method in methods) { #>
            AddService(feed, "<#= method.MethodName #>");
<#  } #>
        }

        protected override FeedEntry GetServiceTemplate(string path)
        {
            switch (path.ToLower())
            {
<#  foreach (var method in methods) { #>
                case "<#= method.MethodName.ToLower() #>":
                    return new <#= entity.Name #><#= method.MethodName #>Entry();
<#  } #>
                default:
                    return base.GetServiceTemplate(path);
            }
        }

        protected override void PostService(string path)
        {
            switch (path.ToLower())
            {
<#  foreach (var method in methods) { #>
                case "<#= method.MethodName.ToLower() #>":
                    var <#= method.MethodName #>Entry = GetRequestFeedEntry<<#= entity.Name #><#= method.MethodName #>Entry>();
                    PostService(
                        <#= method.MethodName #>Entry,
                        "<#= entity.Name #>.<#= method.MethodName #>",
                        () => new object[]
                            {
                                GetEntity(<#= method.MethodName #>Entry.Request.<#= entity.Name #>Id),
<#   foreach (var param in method.MethodParameters) { #>
<#    if (param.RuntimeParamType.Namespace == "Sage.Entity.Interfaces") { #>
<#     if (OrmEntity.GetByName(method.Project, param.ParamType.Substring(1)).GenerateSDataFeed) { #>
                                new <#= param.ParamType.Substring(1) #>RequestHandler().GetEntity(<#= method.MethodName #>Entry.Request.<#= param.ParamName #>Id),
<#     } else { #>
                                EntityFactory.GetById<<#= param.ParamType #>>(<#= method.MethodName #>Entry.Request.<#= param.ParamName #>Id),
<#     } #>
<#    } else { #>
<#     var itemType = GetGenericCollectionItemType(param.RuntimeParamType); #>
<#     if (itemType != null) { #>
<#      if (itemType.Namespace == "Sage.Entity.Interfaces") { #>
<#       if (OrmEntity.GetByName(method.Project, itemType.Name.Substring(1)).GenerateSDataFeed) { #>
                                new List<<#= itemType.Name #>>(new <#= itemType.Name.Substring(1) #>RequestHandler().GetEntities(<#= method.MethodName #>Entry.Request.<#= param.ParamName #>Ids)),
<#       } else { #>
                                new List<string>(<#= method.MethodName #>Entry.Request.<#= param.ParamName #>Ids).ConvertAll(id => EntityFactory.GetById<<#= itemType.Name #>>(id)),
<#       } #>
<#      } else { #>
                                new List<<#= itemType.Name #>>(<#= method.MethodName #>Entry.Request.<#= param.ParamName #>),
<#      } #>
<#     } else { #>
                                <#= method.MethodName #>Entry.Request.<#= param.ParamName #>,
<#     } #>
<#    } #>
<#   } #>
                            },
                        result =>
                            {
                                <#= method.MethodName #>Entry.Request = null;
<#   if (method.RuntimeReturnType != typeof (void)) { #>
<#    if (method.RuntimeReturnType.Namespace == "Sage.Entity.Interfaces") { #>
                                <#= method.MethodName #>Entry.Response = new <#= entity.Name #><#= method.MethodName #>Entry.ServiceResponse {Result = new <#= method.RuntimeReturnType.Name.Substring(1) #>RequestHandler().CopyRelatedEntityToFeedEntry((<#= method.ReturnType #>) result, null, null)};
<#    } else { #>
<#     var returnItemType = GetGenericCollectionItemType(method.RuntimeReturnType); #>
<#     if (returnItemType != null) { #>
<#      if (returnItemType.Namespace == "Sage.Entity.Interfaces") { #>
                                <#= method.MethodName #>Entry.Response = new <#= entity.Name #><#= method.MethodName #>Entry.ServiceResponse {Result = new <#= returnItemType.Name.Substring(1) #>RequestHandler().CopyRelatedEntitiesToFeedEntries((<#= method.ReturnType #>) result, null, null)};
<#      } else { #>
                                <#= method.MethodName #>Entry.Response = new <#= entity.Name #><#= method.MethodName #>Entry.ServiceResponse {Result = new List<<#= returnItemType.Name #>>((IEnumerable<<#= returnItemType.Name #>>) result)};
<#      } #>
<#     } else { #>
                                <#= method.MethodName #>Entry.Response = new <#= entity.Name #><#= method.MethodName #>Entry.ServiceResponse {Result = (<#= method.ReturnType #>) result};
<#     } #>
<#    } #>
<#   } #>
                            });
                    break;
<#  } #>
                default:
                    base.GetServiceTemplate(path);
                    break;
            }
        }
<# } #>

        protected override void CopyFeedEntryToEntity(<#= entity.Name #>Entry entry, <#= entity.InterfaceName #> entity, InclusionNode include)
        {
<# if (properties.Count > 0) { #>
            #region Properties
<#  foreach (var prop in properties) { #>
<#   if (!(prop.IsReadOnly || (entity.HasCompleteCompositeKeyRelationships && prop.IsKeyProperty))) { #>
<#    var name = prop.PropertyName; #>
            if (entry.IsPropertyChanged("<#= name #>"))
            {
                entity.<#= name #> = entry.<#= name #>;
            }
<#   } #>
<#  } #>
            #endregion
<# } #>

<# if (parents.Count > 0) { #>
            #region M:1 Relationships
<#  foreach (var relation in parents) { #>
<#   var otherName = (relation.ParentProperty.Include ? relation.ParentProperty.PropertyName : null); #>
<#   var isCollection = (relation.Cardinality == "1:M"); #>
<#   RequestReferenceCopyFeedEntryToEntity(relation.ChildProperty.PropertyName, otherName, isCollection); #>
<#  } #>
            #endregion
<# } #>

<# if (children.Count > 0) { #>
            #region 1:M Relationships
<#  foreach (var relation in children) { #>
<#   var name = relation.ParentProperty.PropertyName; #>
<#   if (relation.Cardinality == "1:M") { #>
            if (entry.IsPropertyChanged("<#= name #>"))
            {
                var <#= name #>Include = new InclusionNode(InclusionNode.InclusionLevel.Include);
                include.AddChild("<#= name #>", <#= name #>Include);
                <#= name #>RequestHandler.CopyRelatedFeedEntriesToEntities(entry.<#= name #>, entity.<#= name #>, <#= name #>Include);
<#    if (relation.ChildProperty.Include) { #>
                foreach (var child in entity.<#= name #>)
                {
                    child.<#= relation.ChildProperty.PropertyName #> = entity;
                }
<#    } #>
            }
<#   } else { #>
<#     var otherName = (relation.ChildProperty.Include ? relation.ChildProperty.PropertyName : null); #>
<#     RequestReferenceCopyFeedEntryToEntity(name, otherName, false); #>
<#   } #>
<#  } #>
            #endregion
<# } #>

<# if (entity.IsExtension) { #>
<#  var parent = entity.ExtendedEntity; #>
<#  if (parent.GenerateSDataFeed) { #>
            #region 1:1 Parent Entity Extension
<#   RequestReferenceCopyFeedEntryToEntity(parent.Name, entity.Name, false); #>
            #endregion
<#  } #>
<# } #>

<# if (extenders.Count > 0) { #>
            #region Child Extensions
<#  foreach (var child in extenders) { #>
<#   RequestReferenceCopyFeedEntryToEntity(child.Name, entity.Name, false); #>
<#  } #>
            #endregion
<# } #>
            base.CopyFeedEntryToEntity(entry, entity, include);
        }

        protected override void CopyEntityToFeedEntry(<#= entity.InterfaceName #> entity, <#= entity.Name #>Entry entry, InclusionNode include)
        {
<# if (properties.Count > 0) { #>
            #region Properties
<#  foreach (var prop in properties) { #>
<#   var name = prop.PropertyName; #>
<#   var precedence = (int) prop.DisplayCategory; #>
            var <#= name #>Include = include != null ? include.GetChild("<#= name #>") : null;
            if (IsChildIncluded(include, <#= name #>Include, <#= precedence #>, true))
            {
                entry.<#= name #> = entity.<#= name #>;
            }
<#  } #>
            #endregion
<# } #>

<# if (customProperties.Count > 0) { #>
            #region Custom Properties
<#  foreach (var prop in customProperties) { #>
<#   var name = prop.PropertyName; #>
<#   var precedence = (int) prop.DisplayCategory; #>
            var <#= name #>Include = include != null ? include.GetChild("<#= name #>") : null;
<#   if (prop.RuntimeReturnType.Namespace == "Sage.Entity.Interfaces") { #>
            if (IsChildIncluded(include, <#= name #>Include, <#= precedence #>, false))
            {
                entry.<#= name #> = new <#= prop.RuntimeReturnType.Name.Substring(1) #>RequestHandler().CopyRelatedEntityToFeedEntry(entity.<#= name #>, entry.<#= name #>, <#= name #>Include);
            }
<#   } else { #>
<#    var returnItemType = GetGenericCollectionItemType(prop.RuntimeReturnType); #>
<#    if (returnItemType != null) { #>
<#     if (returnItemType.Namespace == "Sage.Entity.Interfaces") { #>
            if (IsChildIncluded(include, <#= name #>Include, <#= precedence #>, false))
            {
                entry.<#= name #> = new <#= returnItemType.Name.Substring(1) #>RequestHandler().CopyRelatedEntitiesToFeedEntries(entity.<#= name #>, entry.<#= name #>, <#= name #>Include);
            }
<#     } else { #>
            if (IsChildIncluded(include, <#= name #>Include, <#= precedence #>, false))
            {
                entry.<#= name #> = new List<<#= returnItemType.Name #>>(entity.<#= name #>);
            }
<#     } #>
<#    } else { #>
            if (IsChildIncluded(include, <#= name #>Include, <#= precedence #>, true))
            {
                entry.<#= name #> = entity.<#= name #>;
            }
<#    } #>
<#   } #>
<#  } #>
            #endregion
<# } #>

<# if (parents.Count > 0) { #>
            #region M:1 Relationships
<#  foreach (var relation in parents) { #>
<#   var precedence = (int) relation.ChildProperty.DisplayCategory; #>
<#   RequestReferenceCopyEntityToFeedEntry(relation.ChildProperty.PropertyName, precedence); #>
<#  } #>
            #endregion
<# } #>

<# if (children.Count > 0) { #>
            #region 1:M Relationships
<#  foreach (var relation in children) { #>
<#   var name = relation.ParentProperty.PropertyName; #>
<#   var precedence = (int) relation.ParentProperty.DisplayCategory; #>
<#   if (relation.Cardinality == "1:M") { #>
            var <#= name #>Include = include != null ? include.GetChild("<#= name #>") : null;
            if (IsChildIncluded(include, <#= name #>Include, <#= precedence #>, false))
            {
                entry.<#= name #> = <#= name #>RequestHandler.CopyRelatedEntitiesToFeedEntries(entity.<#= name #>, entry.<#= name #>, <#= name #>Include);
            }
            else
            {
                entry.<#= name #> = <#= name #>RequestHandler.CreateLinkFeed();
            }
<#   } else { #>
<#    RequestReferenceCopyEntityToFeedEntry(name, precedence); #>
<#   } #>
<#  } #>
            #endregion
<# } #>

<# if (entity.IsExtension) { #>
<#  var parent = entity.ExtendedEntity; #>
<#  if (parent.GenerateSDataFeed) { #>
            #region 1:1 Parent Entity Extension
<#   RequestReferenceCopyEntityToFeedEntry(parent.Name, 3); #>
            #endregion
<#  } #>
<# } #>

<# if (extenders.Count > 0) { #>
            #region Child Extensions
<#  foreach (var child in extenders) { #>
<#   RequestReferenceCopyEntityToFeedEntry(child.Name, 3); #>
<#  } #>
            #endregion
<# } #>
            base.CopyEntityToFeedEntry(entity, entry, include);
        }

        protected override void CalculateETagHash(<#= entity.InterfaceName #> entity, InclusionNode include, ref long hash)
        {
<# if (parents.Count > 0) { #>
            #region M:1 Relationships
<#  foreach (var relation in parents) { #>
<#   var precedence = (int) relation.ChildProperty.DisplayCategory; #>
<#   RequestCalculateETagHash(relation.ChildProperty.PropertyName, precedence); #>
<#  } #>
            #endregion
<# } #>

<# if (children.Count > 0) { #>
            #region 1:M Relationships
<#  foreach (var relation in children) { #>
<#   var precedence = (int) relation.ParentProperty.DisplayCategory; #>
<#   RequestCalculateETagHash(relation.ParentProperty.PropertyName, precedence); #>
<#  } #>
            #endregion
<# } #>

<# if (entity.IsExtension) { #>
<#  var parent = entity.ExtendedEntity; #>
<#  if (parent.GenerateSDataFeed) { #>
            #region 1:1 Parent Entity Extension
<#   RequestCalculateETagHash(parent.Name, 3); #>
            #endregion
<#  } #>
<# } #>

<# if (extenders.Count > 0) { #>
            #region Child Extensions
<#  foreach (var child in extenders) { #>
<#   RequestCalculateETagHash(child.Name, 3); #>
<#  } #>
            #endregion
<# } #>
            base.CalculateETagHash(entity, include, ref hash);
        }

<# if (entity.HasCompositeKey || generator.ToClrType(entity.KeyProperty) != "String") { #>
        protected override void ConvertKey(ref string name, ref object value)
        {
<# if (entity.HasCompositeKey) { #>
<#  if (entity.HasCompleteCompositeKeyRelationships) { #>
<#   foreach (var relation in entity.CompositeKeyRelationships) { #>
<#    var prop = relation.Columns[0].ChildProperty; #>
            if (string.Equals(name, "<#= prop.PropertyName #>", StringComparison.InvariantCultureIgnoreCase))
            {
                name = "<#= relation.ChildProperty.PropertyName #>.Id";
                value = ChangeType(value, typeof (<#= generator.ToClrType(prop) #>));
            }
<#   } #>
<#  } else { #>
<#   foreach (var key in entity.KeyProperties) { #>
            if (string.Equals(name, "<#= key.Reference.PropertyName #>", StringComparison.InvariantCultureIgnoreCase))
            {
                name = "<#= key.Reference.PropertyName #>";
                value = ChangeType(value, typeof (<#= generator.ToClrType(key.Reference) #>));
            }
<#   } #>
<#  } #>
<# } else { #>
            name = "Id";
            value = ChangeType(value, typeof (<#= generator.ToClrType(entity.KeyProperty) #>));
<# } #>
        }
<# } #>

<# if (entity.HasCompositeKey) { #>
        protected override IList<string> GetKeyNames()
        {
            return new[]
                       {
<#  if (entity.HasCompleteCompositeKeyRelationships) { #>
<#   foreach (var relation in entity.CompositeKeyRelationships) { #>
                           "<#= relation.Columns[0].ChildProperty.PropertyName #>",
<#   } #>
<#  } else { #>
<#   foreach (var key in entity.KeyProperties.OrderByOrdinalPosition()) { #>
                           "<#= key.Reference.PropertyName #>",
<#   } #>
<#  } #>
                       };
        }
<# } #>

<# if (entity.UniqueIdentifierProperty != null && entity.UniqueIdentifierProperty.Include) { #>
        protected override Guid? GetUniqueIdentifier(<#= entity.InterfaceName #> entity)
        {
<#  var fieldProp = entity.UniqueIdentifierProperty as OrmFieldProperty; #>
<#  if (fieldProp != null && fieldProp.IsDynamic) { #>
            return (Guid?) entity["<#= entity.UniqueIdentifierProperty.PropertyName #>"];
<# } else { #>
            return entity.<#= entity.UniqueIdentifierProperty.PropertyName #>;
<# } #>
        }
<#  if (fieldProp != null && !(fieldProp.IsReadOnly || (entity.HasCompleteCompositeKeyRelationships && fieldProp.IsKeyProperty))) { #>
        protected override void SetUniqueIdentifier(<#= entity.InterfaceName #> entity, Guid? uuid)
        {
<#   if (fieldProp.IsDynamic) { #>
            entity["<#= entity.UniqueIdentifierProperty.PropertyName #>"] = uuid;
<#   } else { #>
            entity.<#= entity.UniqueIdentifierProperty.PropertyName #> = uuid;
<#   } #>
        }
<#  } #>
<# } #>

<# if (entity.LastUpdatedProperty != null && entity.LastUpdatedProperty.Include) { #>
        protected override DateTime? GetLastUpdated(<#= entity.InterfaceName #> entity)
        {
<#  var fieldProp = entity.LastUpdatedProperty as OrmFieldProperty; #>
<#  if (fieldProp != null && fieldProp.IsDynamic) { #>
            return (DateTime?) entity["<#= entity.LastUpdatedProperty.PropertyName #>"];
<#  } else { #>
            return entity.<#= entity.LastUpdatedProperty.PropertyName #>;
<#  } #>
        }
<# } #>

        #endregion
    }
}

#endregion

#region Feed Related Classes

namespace Sage.Integration.Entity.Feeds
{
    public class <#= entity.Name #>Feed : Feed<<#= entity.Name #>Entry>
    {
        public const string DefaultTitle = "Sage SalesLogix | <#= entityDisplayNamePlural #>";
        public const string ResourceName = "<#= entity.Name #>";
        public const string ResourcePath = "<#= entity.SDataPathName #>";

        public <#= entity.Name #>Feed()
        {
            Title = DefaultTitle;
            SubTitle = "Provides a feed containing <#= entityDisplayName #> details";
            Version = "1.0";
            Generator.Version = Constants.FeedGeneratorVersion;
            Generator.Name = Constants.FeedGenerator;
            Author = new FeedAuthor {Name = "slx"};
        }
    }

    [PresentationSchema("<#= entity.Name #>Overview", PresentationSchemaType.Content)]
    [PresentationSchema("<#= entity.Name #>Detailed", PresentationSchemaType.Alternate)]
    [ResourceManager(typeof (Resources))]
    [XmlType(<#= entity.Name #>Feed.ResourceName, Namespace = Constants.XmlNamespace)]
    [SMEResource(Label = "<#= entityDisplayName #>", PluralName = "<#= entity.PluralName #>", Path = <#= entity.Name #>Feed.ResourcePath,
                 CanGet = true, CanPost = true, CanPut = true, CanDelete = true,
                 CanPagePrevious = true, CanPageNext = true, CanPageIndex = true,
                 BatchingMode = SyncModesType.SyncOrAsync, SupportsETag = true,
                 HasUuid = <#= (entity.UniqueIdentifierProperty != null && entity.UniqueIdentifierProperty.Include).ToString().ToLower() #>)]
    public class <#= entity.Name #>Entry : DynamicFeedEntry
    {
        private static readonly XmlSerializerNamespaces _serializerNamespaces = new XmlSerializerNamespaces(new[] {new XmlQualifiedName("slx", Constants.XmlNamespace)});

        [XmlNamespaceDeclarations]
        [XmlIgnore]
        private static XmlSerializerNamespaces SerializerNamespaces
        {
            get { return _serializerNamespaces; }
        }

        public <#= entity.Name #>Entry()
        {
            Author = new FeedAuthor {Name = "slx"};
        }

<# if (properties.Count > 0) { #>
        #region Properties
<#  foreach (var prop in properties) { #>
<#   var type = generator.ToClrType(prop); #>
<#   var readOnly = prop.IsReadOnly || (entity.HasCompleteCompositeKeyRelationships && prop.IsKeyProperty); #>
<#   var attr = generator.GetPropertySMEMetadataAttribute(prop); #>
<#   FeedEntryProperty(type, prop.PropertyName, readOnly, attr); #>
<#  } #>
        #endregion
<# } #>

<# if (customProperties.Count > 0) { #>
        #region Custom Properties
<#  foreach (var prop in customProperties) { #>
<#   string type; #>
<#   if (prop.RuntimeReturnType.Namespace == "Sage.Entity.Interfaces") { #>
<#    type = prop.RuntimeReturnType.Name.Substring(1) + "Entry"; #>
<#   } else { #>
<#    var returnItemType = GetGenericCollectionItemType(prop.RuntimeReturnType); #>
<#    if (returnItemType != null) { #>
<#     if (returnItemType.Namespace == "Sage.Entity.Interfaces") { #>
<#      type = "Feed<" + returnItemType.Name.Substring(1) + "Entry>"; #>
<#     } else { #>
<#      type = "List<" + returnItemType.Name + ">"; #>
<#     } #>
<#    } else { #>
<#     type = prop.ReturnType; #>
<#    } #>
<#   } #>
<#   var attr = generator.GetPropertySMEMetadataAttribute(prop); #>
<#   FeedEntryProperty(type, prop.PropertyName, true, attr); #>
<#  } #>
        #endregion
<# } #>

<# if (parents.Count > 0) { #>
        #region M:1 Relationships
<#  foreach (var relation in parents) { #>
<#   var type = relation.ParentEntity.Name + "Entry"; #>
<#   var attr = generator.GetPropertySMEMetadataAttribute(relation.ChildProperty); #>
<#   FeedEntryProperty(type, relation.ChildProperty.PropertyName, false, attr); #>
<#  } #>
        #endregion
<# } #>

<# if (children.Count > 0) { #>
        #region 1:M Relationships
<#  foreach (var relation in children) { #>
<#   var type = relation.ChildEntity.Name + "Entry"; #>
<#   if (relation.Cardinality == "1:M") { #>
<#    type = "Feed<" + type + ">"; #>
<#   } #>
<#   var attr = generator.GetPropertySMEMetadataAttribute(relation.ParentProperty); #>
<#   FeedEntryProperty(type, relation.ParentProperty.PropertyName, false, attr); #>
<#  } #>
        #endregion
<# } #>

<# if (entity.IsExtension) { #>
<#  var parent = entity.ExtendedEntity; #>
<#  if (parent.GenerateSDataFeed) { #>
        #region 1:1 Parent Entity Extension
<#   var attr = generator.GetPropertySMEMetadataAttribute(parent); #>
<#   FeedEntryProperty(parent.Name + "Entry", parent.Name, false, attr); #>
        #endregion
<#  } #>
<# } #>

<# if (extenders.Count > 0) { #>
        #region Child Extensions
<#  foreach (var child in extenders) { #>
<#   var attr = generator.GetPropertySMEMetadataAttribute(child); #>
<#   FeedEntryProperty(child.Name + "Entry", child.Name, false, attr); #>
<#  } #>
        #endregion
<# } #>
    }

<# foreach (var method in methods) { #>
    [XmlType("<#= entity.Name #><#= method.MethodName #>", Namespace = Constants.XmlNamespace)]
    [SMEResource(Path = "<#= entity.SDataPathName #>/$service/<#= method.MethodName #>", CanPost = true,
        BatchingMode = SyncModesType.SyncOrAsync, Role = RoleType.serviceOperation)]
    public class <#= entity.Name #><#= method.MethodName #>Entry : FeedEntry
    {
        private static readonly XmlSerializerNamespaces _serializerNamespaces = new XmlSerializerNamespaces(new[] {new XmlQualifiedName("slx", Constants.XmlNamespace)});

        [XmlNamespaceDeclarations]
        [XmlIgnore]
        private static XmlSerializerNamespaces SerializerNamespaces
        {
            get { return _serializerNamespaces; }
        }

        public <#= entity.Name #><#= method.MethodName #>Entry()
        {
            Author = new FeedAuthor {Name = "slx"};
            Request = new ServiceRequest();
        }

        [XmlElement("request")]
        [SMERelationshipProperty(IncludeByDefault = true)]
        public ServiceRequest Request { get; set; }

        [XmlType("<#= entity.Name #><#= method.MethodName #>Request", Namespace = Constants.XmlNamespace)]
        [SMEResource(Role = RoleType.serviceOperation)]
        public class ServiceRequest
        {
            [XmlNamespaceDeclarations]
            [XmlIgnore]
            private static XmlSerializerNamespaces SerializerNamespaces
            {
                get { return _serializerNamespaces; }
            }

            public string <#= entity.Name #>Id { get; set; }
<#   foreach (var param in method.MethodParameters) { #>
<#    if (param.RuntimeParamType.Namespace == "Sage.Entity.Interfaces") { #>
            public string <#= param.ParamName #>Id { get; set; }
<#    } else { #>
<#     var itemType = GetGenericCollectionItemType(param.RuntimeParamType); #>
<#     if (itemType != null) { #>
            [SMERelationshipProperty(IncludeByDefault = true)]
<#      if (itemType.Namespace == "Sage.Entity.Interfaces") { #>
            public List<string> <#= param.ParamName #>Ids { get; set; }
<#      } else { #>
            public List<<#= itemType.Name #>> <#= param.ParamName #> { get; set; }
<#      } #>
<#     } else { #>
            public <#= param.ParamType #> <#= param.ParamName #> { get; set; }
<#     } #>
<#    } #>
<#   } #>
        }

<#  if (method.RuntimeReturnType != typeof (void)) { #>
        [XmlElement("response")]
        [SMERelationshipProperty(IncludeByDefault = true)]
        public ServiceResponse Response { get; set; }

        [XmlType("<#= entity.Name #><#= method.MethodName #>Response", Namespace = Constants.XmlNamespace)]
        [SMEResource(Role = RoleType.serviceOperation)]
        public class ServiceResponse
        {
            [XmlNamespaceDeclarations]
            [XmlIgnore]
            private static XmlSerializerNamespaces SerializerNamespaces
            {
                get { return _serializerNamespaces; }
            }

<#   if (method.RuntimeReturnType.Namespace == "Sage.Entity.Interfaces") { #>
            [SMERelationshipProperty(IncludeByDefault = true)]
            public <#= method.RuntimeReturnType.Name.Substring(1) #>Entry Result { get; set; }
<#   } else { #>
<#    var returnItemType = GetGenericCollectionItemType(method.RuntimeReturnType); #>
<#    if (returnItemType != null) { #>
            [SMERelationshipProperty(IncludeByDefault = true)]
<#     if (returnItemType.Namespace == "Sage.Entity.Interfaces") { #>
            public Feed<<#= returnItemType.Name.Substring(1) #>Entry> Result { get; set; }
<#     } else { #>
            public List<<#= returnItemType.Name #>> Result { get; set; }
<#     } #>
<#    } else { #>
            public <#= method.ReturnType #> Result { get; set; }
<#    } #>
<#   } #>
        }
<#  } #>
    }
<# } #>
}

#endregion
<#+
[Dependency]
public IDictionary Context { get; set; }
#>
<#+ private void RequestRelatedHandler(string propName, string entityName, string forwardPath, string backwardPath, bool isSingle) { #>
        private <#= entityName #>RequestHandler _<#= propName #>RequestHandler;
        private <#= entityName #>RequestHandler <#= propName #>RequestHandler
        {
            get { return _<#= propName #>RequestHandler ?? (_<#= propName #>RequestHandler = new <#= entityName #>RequestHandler(this, <#= forwardPath != null ? "\"" + forwardPath + "\"" : "null" #>, <#= backwardPath != null ? "\"" + backwardPath + "\"" : "null" #>, <#= isSingle.ToString().ToLower() #>)); }
        }
<#+ } #>
<#+ private void RequestBuildTemplateEntity(string name, bool isCollection, int precedence) { #>
            var <#= name #>Include = include != null ? include.GetChild("<#= name #>") : null;
            if (IsChildIncluded(include, <#= name #>Include, <#= precedence #>, false))
            {
<#+  if (isCollection) { #>
                entity.<#= name #>.Add(<#= name #>RequestHandler.BuildTemplateEntity(<#= name #>Include));
<#+  } else { #>
                entity.<#= name #> = <#= name #>RequestHandler.BuildTemplateEntity(<#= name #>Include);
<#+  } #>
            }
<#+ } #>
<#+ private void RequestReferenceCopyFeedEntryToEntity(string name, string otherName, bool isCollection) { #>
            if (entry.IsPropertyChanged("<#= name #>"))
            {
                var <#= name #>Include = new InclusionNode(InclusionNode.InclusionLevel.Include);
                include.AddChild("<#= name #>", <#= name #>Include);
                var parent = <#= name #>RequestHandler.CopyRelatedFeedEntryToEntity(entry.<#= name #>, entity.<#= name #>, <#= name #>Include);
                entity.<#= name #> = parent;
<#+  if (otherName != null) { #>
                if (parent != null)
                {
<#+   if (isCollection) { #>
                    parent.<#= otherName #>.Add(entity);
<#+   } else { #>
                    parent.<#= otherName #> = entity;
<#+   } #>
                }
<#+  } #>
            }
<#+ } #>
<#+ private void RequestReferenceCopyEntityToFeedEntry(string name, int precedence) { #>
            var <#= name #>Include = include != null ? include.GetChild("<#= name #>") : null;
            if (IsChildIncluded(include, <#= name #>Include, <#= precedence #>, false))
            {
                entry.<#= name #> = <#= name #>RequestHandler.CopyRelatedEntityToFeedEntry(entity.<#= name #>, entry.<#= name #>, <#= name #>Include);
            }
            else
            {
                try
                {
                    entry.<#= name #> = <#= name #>RequestHandler.CreateLinkEntry(entity.<#= name #>);
                }
                catch (ObjectNotFoundException)
                {
                }
            }
<#+ } #>
<#+ private void RequestCalculateETagHash(string name, int precedence) { #>
            var <#= name #>Include = include != null ? include.GetChild("<#= name #>") : null;
            if (IsChildIncluded(include, <#= name #>Include, <#= precedence #>, false))
            {
                <#= name #>RequestHandler.CalculateRelatedETagHash(entity.<#= name #>, <#= name #>Include, ref hash);
            }
<#+ } #>
<#+ private void FeedEntryProperty(string type, string name, bool readOnly, string smeAttribute) { #>
        <#= type #> _<#= name #>;
<#+  if (!string.IsNullOrEmpty(smeAttribute)) { #>
        [<#= smeAttribute #>]
<#+  } #>
        public <#= typeof (FeedEntry).GetProperty(name) != null ? "new " : "" #><#= type #> <#= name #>
        {
            get { return _<#= name #>; }
            <#= readOnly ? "internal" : "" #> set { SetProperty("<#= name #>", ref _<#= name #>, value); }
        }
<#+ } #>
<#+ private static bool IsTypeSupported(Type type)
    {
        if (type == null)
        {
            return false;
        }

        if (type == typeof (string))
        {
            return true;
        }

        if (type.IsGenericType)
        {
            if (type.GetGenericTypeDefinition() == typeof (Nullable<>))
            {
                return IsTypeSupported(type.GetGenericArguments()[0]);
            }

            var itemType = GetGenericCollectionItemType(type);

            if (itemType != null)
            {
                return IsTypeSupported(itemType);
            }
        }
        else
        {
            if (type.IsValueType && type.Namespace == "System")
            {
                return true;
            }

            if (type.IsInterface && type.Namespace == "Sage.Entity.Interfaces")
            {
                return true;
            }
        }

        return false;
    } #>
<#+ private static Type GetGenericCollectionItemType(Type type)
    {
        if (type.IsGenericType)
        {
            var args = type.GetGenericArguments();
            if (args.Length == 1 &&
                typeof(ICollection<>).MakeGenericType(args).IsAssignableFrom(type))
            {
                return args[0];
            }
        }
        return null;
    } #>]]></template>
  <description>Default SalesLogix SData template</description>
</codeTemplate>