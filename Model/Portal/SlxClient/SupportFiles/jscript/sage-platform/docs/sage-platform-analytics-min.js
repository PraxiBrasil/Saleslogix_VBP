/*
 * SagePlatform
 * Copyright(c) 2009, Sage Software.
 */


Sage.Analytics={colorPalette:{'blue 0':'dfe8f6','blue 6':'00a1de','green 3':'c1d59f','pink 5':'a44e81','orange 2':'f8d6aa','blue 4':'55c0e9','green 6':'69923a','pink 2':'e2afcd','orange 7':'af6200','blue 3':'80d0ef','green 8':'35491d','pink 4':'c55e9b','orange 3':'f4c180','blue 7':'0079a7','green 5':'86a85c','pink 8':'421f34','orange 6':'e98300','blue 2':'aae0f4','green 7':'4f6e2c','pink 3':'d486b4','orange 8':'754200','blue 5':'2bb1e4','green 2':'d6e3bf','pink 6':'833f67','orange 5':'ed982b','blue 8':'00516f','green 4':'a4bf7d','pink 7':'632f4e','orange 4':'f0ac55'},createObject:function(base){var O=function(){};O.prototype=base;return new O();},now:function(){var minutes,value=new Date(),renderer=Ext.util.Format.dateRenderer(ConvertToPhpDateTimeFormat(getContextByKey('userDateFmtStr')+" "+getContextByKey('userTimeFmtStr')));return renderer(value);},getColors:function(num){if(!num){return;}
var lookupLg=['blue 6','green 3','pink 5','orange 2','blue 4','green 6','pink 2','orange 7','blue 3','green 8','pink 4','orange 3','blue 7','green 5','pink 8','orange 6','blue 2','green 7','pink 3','orange 8','blue 5','green 2','pink 6','orange 5','blue 8','green 4','pink 7','orange 4'],lookupSm=['green 5','blue 3','green 7','blue 6','green 3','blue 7'],ret=[],i,j;if(num<=6){for(i=0;i<num;i++){ret[i]=Sage.Analytics.colorPalette[lookupSm[i]];}}
else{for(j=0;j<num;j++){ret[j]=Sage.Analytics.colorPalette[lookupLg[j]];}}
return ret;},getColor:function(idx){var lookup=['blue 6','green 3','pink 5','orange 2','blue 4','green 6','pink 2','orange 7','blue 3','green 8','pink 4','orange 3','blue 7','green 5','pink 8','orange 6','blue 2','green 7','pink 3','orange 8','blue 5','green 2','pink 6','orange 5','blue 8','green 4','pink 7','orange 4'];return Sage.Analytics.colorPalette[lookup[idx]];},counter:1,generateString:function(str){return str+Sage.Analytics.counter++;},markup:{editorWindow:function(init){var $items=[],prop,cust,editorFields=init.editorFields,urls=init.urls,scope=init.scope;for(prop in editorFields){if(editorFields.hasOwnProperty(prop)){switch(prop){case'entityField':$items.push(this[prop](editorFields[prop],editorFields.groupField,editorFields.dimensionField,editorFields.metricField,urls.group,urls.dimension,urls.metric,scope));break;case'customFields':for(cust in editorFields.customFields){if(editorFields.customFields.hasOwnProperty(cust)){$items.push(this.customField(editorFields.customFields[cust]));}}
break;case'radioNames':$items.push(this[prop](editorFields[prop],editorFields.radioTruncate,editorFields.truncField,scope));break;case'radioTruncate':$items.push(this[prop](editorFields[prop],editorFields.truncField,scope));break;default:$items.push(this[prop](editorFields[prop],scope));}}}
return new Ext.Window({id:scope.config.editorWindow,title:init.title,tools:[{id:'help',handler:function(){window.open(String.format(getContextByKey('WebHelpUrlFmt'),'Using_Widgets'),'MCWebHelp');}}],width:init.width||500,height:init.height||(function(){return Ext.isIE8?400:350;}()),layout:init.layout||'fit',closeAction:init.closeAction||'close',items:new Ext.FormPanel({labelAlign:init.labelAlign||'left',labelWidth:init.labelWidth||125,layout:'form',border:init.border||false,style:init.style||'padding:5px',items:$items,buttons:[{text:'OK',handler:function(){if(init.ok&&typeof(init.ok)==='function'){return init.ok(scope);}
var win=Ext.getCmp(scope.config.editorWindow),eField=Ext.getCmp(editorFields.entityField),gField=Ext.getCmp(editorFields.groupField),dField=Ext.getCmp(editorFields.dimensionField),mField=Ext.getCmp(editorFields.metricField),callWidget=Ext.getCmp(scope.config.panel),att,prop,uri=[],flag=true;if(!eField.validate()||!gField.validate()||!dField.validate()||!mField.validate()){flag=false;}
if(editorFields.titleField){scope.config.title=Ext.getCmp(editorFields.titleField).getValue();}
if(editorFields.captionField){scope.config.subtitle=Ext.getCmp(editorFields.captionField).getValue();}
if(editorFields.xAxisField){scope.config.xAxisName=Ext.getCmp(editorFields.xAxisField).getValue();}
if(editorFields.yAxisField){scope.config.yAxisName=Ext.getCmp(editorFields.yAxisField).getValue();}
if(editorFields.goalField){scope.config.goal=Ext.getCmp(editorFields.goalField).getValue();}
if(editorFields.truncField){scope.config.truncNum=Ext.getCmp(editorFields.truncField).getValue();}
uri.push('slxdata.ashx/slx/crm/-/analytics?');if(scope.config.entity){uri.push('entity=',scope.config.entity,'&');}
if(scope.config.groupname){uri.push('groupname=',scope.config.groupname,'&');}
if(scope.config.dimension){uri.push('dimension=',scope.config.dimension,'&');}
if(scope.config.metric){uri.push('metric=',scope.config.metric,'&');}
if(scope.config.limit){uri.push('limit=',scope.config.limit,'&');}
if(scope.config.combineother==='true'){uri.push('combineother=true');}
for(prop in scope.definition.qsParams){if(scope.definition.qsParams.hasOwnProperty(prop)){uri.push('&',prop,'=',scope.definition.qsParams[prop]);}}
scope.config.datasource=uri.join('');if(flag){for(att in scope.config){if(scope.config.hasOwnProperty(att)){if(!scope.definition.filterList[att]){scope._options[att]=scope.config[att];}}}
scope.config.edited=true;scope.fireEvent('persist');scope.init();win.close();callWidget.focus();}},scope:scope},{text:'Cancel',handler:function(){var win=Ext.getCmp(scope.config.editorWindow),callWidget=Ext.getCmp(scope.config.panel);win.close();callWidget.focus();}}]})});},titleField:function(id,scope){return{id:id,xtype:'textfield',fieldLabel:Sage.Analytics.WidgetResource.lblTitle,anchor:'97%',listeners:{'render':{fn:function(){var txtField=Ext.getCmp(id);if(scope.config.title){txtField.setRawValue(scope.config.title);}},scope:scope}}};},customField:function(obj){var ret={},prop;for(prop in obj){if(obj.hasOwnProperty(prop)){ret[prop]=obj[prop];}}
return ret;},entityField:function(id,gcid,dcid,mcid,groupListURL,dimensionURL,metricURL,scope){return{id:id,xtype:'combo',forceSelection:true,triggerAction:'all',fieldLabel:Sage.Analytics.WidgetResource.lblEntity,anchor:'97%',allowBlank:false,emptyText:Sage.Analytics.WidgetResource.emptyEntity,store:new Ext.data.JsonStore({autoLoad:true,url:'slxdata.ashx/slx/crm/-/groups/context/entityList?filter=analytics',root:'items',totalProperty:'total_count',fields:['fullName','displayName'],listeners:{'load':{fn:function($this,records,options){var ent,win=Ext.getCmp(scope.config.editorWindow),combo=Ext.getCmp(id),len=records.length,i;win.el.unmask();ent=scope.config.entity;if(ent){for(i=0;i<len;i++){if(records[i].data.fullName===ent){combo.el.removeClass('x-form-empty-field');combo.setRawValue(records[i].data.displayName);combo.fireEvent('change',combo,ent);}}}},scope:scope}}}),valueField:'fullName',displayField:'displayName',mode:'local',listeners:{'change':function(combo,newVal,oldVal){var entityName=newVal.replace("Sage.Entity.Interfaces.I",""),grpCombo=Ext.getCmp(gcid),gstore=grpCombo.getStore(),dimensionCombo=Ext.getCmp(dcid),dstore=dimensionCombo.getStore(),metricCombo=Ext.getCmp(mcid),mstore=metricCombo.getStore();gstore.proxy.conn.url=String.format(groupListURL,entityName);gstore.load();dstore.proxy.conn.url=String.format(dimensionURL,entityName);dstore.load();mstore.proxy.conn.url=String.format(metricURL,entityName);mstore.load();},'select':{fn:function(combo,record,index){var gCombo=Ext.getCmp(gcid),dCombo=Ext.getCmp(dcid),mCombo=Ext.getCmp(mcid);scope.config.entity=record.get(combo.valueField);gCombo.setValue('');dCombo.setValue('');mCombo.setValue('');},scope:scope}}};},groupField:function(id,scope){return{id:id,xtype:'combo',forceSelection:true,triggerAction:'all',fieldLabel:Sage.Analytics.WidgetResource.lblGroup,anchor:'97%',allowBlank:false,emptyText:Sage.Analytics.WidgetResource.emptyGroup,store:new Ext.data.JsonStore({autoLoad:false,url:'slxdata.ashx/slx/crm/-/groups/context/grouplist/Account',root:'items',totalProperty:'total_count',fields:['groupId','groupName','displayName','isAdHoc'],listeners:{'load':{fn:function($this,records,options){var grp,combo=Ext.getCmp(id),len=records.length,i;grp=scope._options.groupname;if(grp){for(i=0;i<len;i++){if(records[i].data.groupName===grp){combo.el.removeClass('x-form-empty-field');combo.setRawValue(records[i].data.displayName);combo.fireEvent('change',combo,grp);}}}},scope:scope}}}),valueField:'groupName',displayField:'displayName',mode:'local',listeners:{'select':{fn:function(combo,record,index){scope.config.groupname=record.get(combo.valueField);scope.config.groupid=record.get('groupId');},scope:scope}}};},dimensionField:function(id,scope){return{id:id,xtype:'tooltipcombo',forceSelection:true,triggerAction:'all',fieldLabel:Sage.Analytics.WidgetResource.lblDimension,anchor:'97%',allowBlank:false,emptyText:Sage.Analytics.WidgetResource.emptyDimension,store:new Ext.data.JsonStore({autoLoad:false,url:'slxdata.ashx/slx/crm/-/analytics/dimension/Opportunity',root:'items',totalProperty:'total_count',fields:['name','displayName','analyticsDescription'],listeners:{'load':{fn:function($this,records,options){var dim,combo=Ext.getCmp(id),len=records.length,i;dim=scope._options.dimension;if(dim){for(i=0;i<len;i++){if(records[i].data.name===dim){combo.el.removeClass('x-form-empty-field');combo.setRawValue(records[i].data.displayName);combo.fireEvent('change',combo,dim);}}}},scope:scope}}}),valueField:'name',displayField:'displayName',tooltipField:'analyticsDescription',mode:'local',tipDisplayMode:'inline',listeners:{'select':{fn:function(combo,record,index){scope.config.dimension=record.get(combo.valueField);},scope:scope}}};},metricField:function(id,scope){return{id:id,xtype:'tooltipcombo',forceSelection:true,triggerAction:'all',fieldLabel:Sage.Analytics.WidgetResource.lblMetric,anchor:'97%',allowBlank:false,emptyText:Sage.Analytics.WidgetResource.emptyMetric,store:new Ext.data.JsonStore({autoLoad:false,url:'slxdata.ashx/slx/crm/-/analytics/metric/Opportunity',root:'items',totalProperty:'total_count',fields:['name','displayName','analyticsDescription'],listeners:{'load':{fn:function($this,records,options){var met,combo=Ext.getCmp(id),len=records.length,i;met=scope._options.metric;if(met){for(i=0;i<len;i++){if(records[i].data.name===met){combo.el.removeClass('x-form-empty-field');combo.setRawValue(records[i].data.displayName);combo.fireEvent('change',combo,met);}}}},scope:scope}}}),valueField:'name',displayField:'displayName',tooltipField:'analyticsDescription',mode:'local',tipDisplayMode:'inline',listeners:{'select':{fn:function(combo,record,index){scope.config.metric=record.get(combo.valueField);},scope:scope}}};},captionField:function(id,scope){return{id:id,xtype:'textfield',fieldLabel:Sage.Analytics.WidgetResource.lblCaption,anchor:'97%',listeners:{'render':{fn:function(){var txtField=Ext.getCmp(id);if(scope.config.subtitle){txtField.setRawValue(scope.config.subtitle);}},scope:scope}}};},xAxisField:function(id,scope){return{id:id,xtype:'textfield',fieldLabel:Sage.Analytics.WidgetResource.lblXaxis,anchor:'97%',listeners:{'render':{fn:function(){var txtField=Ext.getCmp(id);if(scope.config.xAxisName){txtField.setRawValue(scope.config.xAxisName);}},scope:scope}}};},yAxisField:function(id,scope){return{id:id,xtype:'textfield',fieldLabel:Sage.Analytics.WidgetResource.lblYaxis,anchor:'97%',listeners:{'render':{fn:function(){var txtField=Ext.getCmp(id);if(scope.config.yAxisName){txtField.setRawValue(scope.config.yAxisName);}},scope:scope}}};},goalField:function(id,scope){return{id:id,xtype:'numberfield',fieldLabel:Sage.Analytics.WidgetResource.lblGoal,anchor:'97%',listeners:{'render':{fn:function(){var txtField=Ext.getCmp(id);if(scope.config.goal){txtField.setRawValue(scope.config.goal);}}},scope:scope}};},truncField:function(id,scope){return{id:id,xtype:'numberfield',fieldLabel:Sage.Analytics.WidgetResource.lblMaxLength,anchor:'97%',listeners:{'render':{fn:function(){var txtField=Ext.getCmp(id);if(scope.config.truncNum){txtField.setRawValue(scope.config.truncNum);}}},scope:scope}};},radioNames:function(id,rdo,txt,scope){return{xtype:'radiogroup',id:id,fieldLabel:Sage.Analytics.WidgetResource.lblNames,items:[{boxLabel:Sage.Analytics.WidgetResource.yes,name:'rdLabels',inputValue:'true'},{boxLabel:Sage.Analytics.WidgetResource.no,name:'rdLabels',inputValue:'false'}],listeners:{'change':{fn:function($this,checked,loaded){scope.config.showLabels=checked.inputValue;var rdoTrunc=Ext.getCmp(rdo),txtTrunc=Ext.getCmp(txt);if(checked.inputValue==='true'){rdoTrunc.enable();txtTrunc.enable();}else{rdoTrunc.disable();txtTrunc.disable();}},scope:scope},'render':{fn:function(){var rdoGroup=Ext.getCmp(id),rdoTrunc=Ext.getCmp(rdo),txtTrunc=Ext.getCmp(txt);if(scope._options.showLabels==='true'){rdoGroup.setValue([true,false]);if(rdoTrunc.disabled){rdoTrunc.enable();}
if(txtTrunc.disabled){txtTrunc.enable();}}
else{rdoGroup.setValue([false,true]);if(!rdoTrunc.disabled){rdoTrunc.disable();}
if(!txtTrunc.disabled){txtTrunc.disable();}}},scope:scope}}};},radioTruncate:function(id,txt,scope){return{xtype:'radiogroup',id:id,fieldLabel:Sage.Analytics.WidgetResource.lblTruncate,items:[{boxLabel:Sage.Analytics.WidgetResource.yes,name:'rdTrunc',inputValue:'true'},{boxLabel:Sage.Analytics.WidgetResource.no,name:'rdTrunc',inputValue:'false'}],listeners:{'change':{fn:function($this,checked,loaded){var txtTrunc=Ext.getCmp(txt);scope.config.truncLabels=checked.inputValue;if(checked.inputValue==='true'){txtTrunc.enable();}else{txtTrunc.disable();}},scope:scope},'render':{fn:function(){var rdoGroup=Ext.getCmp(id),txtTrunc=Ext.getCmp(txt);if(scope._options.truncLabels==='true'){rdoGroup.setValue([true,false]);txtTrunc.enable();}
else{rdoGroup.setValue([false,true]);txtTrunc.disable();}},scope:scope}}};},radioSlices:function(id,scope){return{xtype:'radiogroup',id:id,fieldLabel:Sage.Analytics.WidgetResource.lblSlices,items:[{boxLabel:Sage.Analytics.WidgetResource.five,name:'rdSlices',inputValue:'5'},{boxLabel:Sage.Analytics.WidgetResource.ten,name:'rdSlices',inputValue:'10'}],listeners:{'change':{fn:function($this,checked,loaded){scope.config.limit=checked.inputValue;},scope:scope},'render':{fn:function(){var rdoGroup=Ext.getCmp(id);rdoGroup.setValue(scope._options.limit);},scope:scope}}};},radioOther:function(id,scope){return{xtype:'radiogroup',id:id,fieldLabel:Sage.Analytics.WidgetResource.lblOther,items:[{boxLabel:Sage.Analytics.WidgetResource.yes,name:'rdOther',inputValue:'true'},{boxLabel:Sage.Analytics.WidgetResource.no,name:'rdOther',inputValue:'false'}],listeners:{'change':{fn:function($this,checked,loaded){scope.config.combineother=checked.inputValue;},scope:scope},'render':{fn:function(){var rdoGroup=Ext.getCmp(id);if(scope.config.combineother==='true'){rdoGroup.setValue([true,false]);}
else{rdoGroup.setValue([false,true]);}},scope:scope}}};},radioLegend:function(id,scope){return{xtype:'radiogroup',id:id,fieldLabel:Sage.Analytics.WidgetResource.lblLegend,items:[{boxLabel:Sage.Analytics.WidgetResource.yes,name:'rdLegend',inputValue:'true'},{boxLabel:Sage.Analytics.WidgetResource.no,name:'rdLegend',inputValue:'false'}],listeners:{'change':{fn:function($this,checked,loaded){scope.config.showLegend=checked.inputValue;},scope:scope},'render':{fn:function(){var rdoGroup=Ext.getCmp(id);if(scope.config.showLegend==='true'){rdoGroup.setValue([true,false]);}
else{rdoGroup.setValue([false,true]);}},scope:scope}}};}},truncate:function(val,num){var i=0,len=val.length,res=[];if(typeof num==='string'){num=parseInt(num,10);}
if(typeof val==='string'){return val.length>num?val.slice(0,num)+'...':val;}
if(val.map&&typeof val.map==='function'){return val.map(function(v,i,c){return v.length>num?v.slice(0,num)+'...':v;});}
else{for(i;i<len;i++){res.push(val[i].slice(0,num)+'...');}
return res;}},localize:function(val){function keyify(key){return key?key.replace(/[^a-zA-Z0-9]/g,'_'):"";}
return Sage.Analytics.WidgetResource[keyify(val)]?Sage.Analytics.WidgetResource[keyify(val)]:val;},WidgetDefinitions:{}};